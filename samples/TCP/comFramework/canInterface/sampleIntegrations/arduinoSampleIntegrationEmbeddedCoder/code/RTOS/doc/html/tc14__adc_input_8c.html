<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>RTuinOS: tc14_adcInput.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">RTuinOS&#160;<span id="projectnumber">0.9</span></div>
   <div id="projectbrief">Small Scale RTOS for Arduino 1.0.5</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('tc14__adc_input_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>tc14_adcInput.c File Reference</h1>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &lt;arduino.h&gt;</code><br/>
<code>#include &quot;rtos.h&quot;</code><br/>
<code>#include &quot;stdout.h&quot;</code><br/>
</div><table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tc14__adc_input_8c.html#aeb7a7ba1ab7e0406f1b5ab36d579f585">LED</a>&#160;&#160;&#160;13</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a9bf303a995133cba14f6db16df608457"></a><!-- doxytag: member="tc14_adcInput.c::TI_FLASH" ref="a9bf303a995133cba14f6db16df608457" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>TI_FLASH</b>&#160;&#160;&#160;150</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a76fb0fe53c53fb992a7418beccb025d3"></a><!-- doxytag: member="tc14_adcInput.c::VAL_REFS" ref="a76fb0fe53c53fb992a7418beccb025d3" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_REFS</b>&#160;&#160;&#160;3</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a24fd73646684461f77406c2301342fe0"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADLAR" ref="a24fd73646684461f77406c2301342fe0" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADLAR</b>&#160;&#160;&#160;0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a7fcde0d457831d1ad17756e8a8648fff"></a><!-- doxytag: member="tc14_adcInput.c::VAL_MUX" ref="a7fcde0d457831d1ad17756e8a8648fff" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_MUX</b>&#160;&#160;&#160;0x1e</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a34ebf112ce7e25f2d49a5d59e5c7c24a"></a><!-- doxytag: member="tc14_adcInput.c::U_REF" ref="a34ebf112ce7e25f2d49a5d59e5c7c24a" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>U_REF</b>&#160;&#160;&#160;2.56</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a0180a4031a0c62040afa891f0fee073c"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ACME" ref="a0180a4031a0c62040afa891f0fee073c" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ACME</b>&#160;&#160;&#160;0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="adc4c3760ad9af8067ad874a25e528b96"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADTS" ref="adc4c3760ad9af8067ad874a25e528b96" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADTS</b>&#160;&#160;&#160;4</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a68daa11284c4084537fa851f365a284c"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADEN" ref="a68daa11284c4084537fa851f365a284c" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADEN</b>&#160;&#160;&#160;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a05dff19d3b08c911e129640110f8e8f6"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADSC" ref="a05dff19d3b08c911e129640110f8e8f6" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADSC</b>&#160;&#160;&#160;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af18d12343dcdf32f6805e7efbe0751c9"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADATE" ref="af18d12343dcdf32f6805e7efbe0751c9" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADATE</b>&#160;&#160;&#160;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a905ad7f06a0fcc1afe4dfc00c81a579a"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADIF" ref="a905ad7f06a0fcc1afe4dfc00c81a579a" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADIF</b>&#160;&#160;&#160;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a89980ba55997151d002e2b9f49c12938"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADIE" ref="a89980ba55997151d002e2b9f49c12938" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADIE</b>&#160;&#160;&#160;0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab51da2ac63dba2a2be204654330b1889"></a><!-- doxytag: member="tc14_adcInput.c::VAL_ADPS" ref="ab51da2ac63dba2a2be204654330b1889" args="" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><b>VAL_ADPS</b>&#160;&#160;&#160;7</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tc14__adc_input_8c.html#a7dfd9b79bc5a37d7df40207afbc5431f">setup</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tc14__adc_input_8c.html#a0b33edabd7f1c4e4a0bf32c67269be2f">loop</a> (void)</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Test case 14 of RTuinOS. A user interrupt is applied to pick the results of an analog input channel, which is running in regular, hardware triggered Auto Trigger Mode. It could seem to be straight forward, to use the timing capabilities of an RTOS to trigger the conversions of an ADC, a regular task would be used to do so. However, signal processing of fluctuating input signals by regular sampling the input suffers from incorrect timing. Although in mean the timing of a regular task is very precise, the actual points in time, when a task is invoked are not precisely equidistant. The invokations may be delayed by an arbitrary, fluctuating tiny time span. This holds true even for a task of high priority -- even if here the so called jitter will be less. If the signal processing assumes regular sampling of the input but actually does do this with small time shifts, it will see an error, which is approximately equal to the first derivative of the input signel times the time shift. The latter is a random quantity so the error also is a random quantity proportional to the derivative of the input signal. In the frequency domain this mean that the expected error increases linearly with the input frequency. Consequently, task triggered ADC conversions must be used only for slowly changing input signals, it might e.g. be adequate for reading a temperature input. All other applications need to trigger the conversions by a sofwtare independent, accurate hardware signal. The software becomes a slave of this hardware trigger. This RTuinOS sample application uses timer/counter 0 in the unchanged Arduino standard configuration to trigger the conversions of the ADC. The overflow interrupt is used for this purpose yielding a conversion rate of about 1221 Hz. A task of high priority is awaked on each conversion-complete event and reads the conversion result. The read values are down-sampled and passed to a much slower secondary task, which prints them to the Arduino console window. Proper down-sampling is a CPU time consuming operation, which is hard to implement on a tiny eight Bit controller. Here we use the easiest possible to implement filter with rectangular impulse response. It adds the last recent N input values and divides the reuslt by N. We exploit the fact, that we have 10 Bit ADC values but use a 16 Bit arithemtics anyway: We can safely sum up up to 64 values without any danger of overflow. The division by N=64 is not necessary at all; this constant value just changes the scaling of the result (i.e. the scaling binary value to Volt), which has to be considered for any output operation anyway. It doesn't matter to this "consider" which scaling we actually have, it's just another constant to use. Regardless of the poor damping of this filter we use it to reduce the task rate by 32. (TBC)</p>
<p>Copyright (C) 2013 Peter Vranken (mailto:<a href="mailto:Peter_Vranken@Yahoo.de">Peter_Vranken@Yahoo.de</a>)</p>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.</p>
<p>You should have received a copy of the GNU Lesser General Public License along with this program. If not, see &lt;<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</p>
<p>Module interface setup loop Local functions blink </p>
</div><hr/><h2>Define Documentation</h2>
<a class="anchor" id="aeb7a7ba1ab7e0406f1b5ab36d579f585"></a><!-- doxytag: member="tc14_adcInput.c::LED" ref="aeb7a7ba1ab7e0406f1b5ab36d579f585" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LED&#160;&#160;&#160;13</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Pin 13 has an LED connected on most Arduino boards. </p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a7dfd9b79bc5a37d7df40207afbc5431f"></a><!-- doxytag: member="tc14_adcInput.c::setup" ref="a7dfd9b79bc5a37d7df40207afbc5431f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The initalization of the RTOS tasks and general board initialization. </p>

</div>
</div>
<a class="anchor" id="a0b33edabd7f1c4e4a0bf32c67269be2f"></a><!-- doxytag: member="tc14_adcInput.c::loop" ref="a0b33edabd7f1c4e4a0bf32c67269be2f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void loop </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The application owned part of the idle task. This routine is repeatedly called whenever there's some execution time left. It's interrupted by any other task when it becomes due. </p>
<dl class="remark"><dt><b>Remarks:</b></dt><dd>Different to all other tasks, the idle task routine may and should return. (The task as such doesn't terminate). This has been designed in accordance with the meaning of the original Arduino loop function. </dd></dl>

</div>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="tc14__adc_input_8c.html">tc14_adcInput.c</a>      </li>
      <li class="footer">Generated on Mon Jul 1 2013 20:50:01 for RTuinOS by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
