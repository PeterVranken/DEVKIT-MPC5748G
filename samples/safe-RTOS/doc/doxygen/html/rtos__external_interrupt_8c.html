<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>safe-RTOS (VLE): rtos_externalInterrupt.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">safe-RTOS (VLE)
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">safe-RTOS (VLE) - A simple RTOS with safety support for MPC5748G</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('rtos__external_interrupt_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">rtos_externalInterrupt.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;limits.h&gt;</code><br />
<code>#include &lt;assert.h&gt;</code><br />
<code>#include &quot;<a class="el" href="typ__types_8h_source.html">typ_types.h</a>&quot;</code><br />
<code>#include &quot;MPC5748G.h&quot;</code><br />
<code>#include &quot;<a class="el" href="rtos_8h_source.html">rtos.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="rtos__external_interrupt_8h_source.html">rtos_externalInterrupt.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a88a271864adecb3d629668674fa0815a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtos__external_interrupt_8c.html#a88a271864adecb3d629668674fa0815a">rtos_osInitINTCInterruptController</a> (void)</td></tr>
<tr class="separator:a88a271864adecb3d629668674fa0815a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a10a6460ff9e902f2d0ac42394e0e4fea"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtos__external_interrupt_8c.html#a10a6460ff9e902f2d0ac42394e0e4fea">rtos_osRegisterInterruptHandler</a> (const <a class="el" href="rtos_8h.html#a671a05cb46411e64b58a457394c3e749">rtos_interruptServiceRoutine_t</a> pInterruptHandler, unsigned int processorID, unsigned int vectorNum, unsigned int psrPriority, bool isPreemptable)</td></tr>
<tr class="separator:a10a6460ff9e902f2d0ac42394e0e4fea"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:af34c0be87ce8f08cd2ae73d5469ac308"><td class="memItemLeft" align="right" valign="top"><a class="el" href="rtos_8h.html#a671a05cb46411e64b58a457394c3e749">rtos_interruptServiceRoutine_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtos__external_interrupt_8c.html#af34c0be87ce8f08cd2ae73d5469ac308">rtos_endOfINTCInterruptHandlerAry</a> [0]</td></tr>
<tr class="separator:af34c0be87ce8f08cd2ae73d5469ac308"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca10086c1117b052b672a8ff90147edc"><td class="memItemLeft" align="right" valign="top">volatile uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtos__external_interrupt_8c.html#aca10086c1117b052b672a8ff90147edc">inc_pirUnregisteredInterrupt</a> = UINT32_MAX</td></tr>
<tr class="separator:aca10086c1117b052b672a8ff90147edc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This module holds a few routines, which are needed to configure the handling of External Interrupts (IVOR #4). The interrupt controller is initialized and the operating system code has the chance to register the handlers for particular I/O interrupts.<br />
 The code in this module used to be part of the startup code in the other samples.</p>
<p>Copyright (C) 2017-2020 Peter Vranken (<a href="#" onclick="location.href='mai'+'lto:'+'Pet'+'er'+'_Vr'+'an'+'ken'+'@Y'+'aho'+'o.'+'de'; return false;">Peter<span style="display: none;">.nosp@m.</span>_Vra<span style="display: none;">.nosp@m.</span>nken@<span style="display: none;">.nosp@m.</span>Yaho<span style="display: none;">.nosp@m.</span>o.de</a>)</p>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.</p>
<p>You should have received a copy of the GNU Lesser General Public License along with this program. If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a88a271864adecb3d629668674fa0815a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rtos_osInitINTCInterruptController </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialize the interrupt controller INTC. The interrupt table with all interrupt service descriptors is initialized to contain a dummy ISR for all interrupts and it is then registered at the hardware device INTC for use.<br />
 The interrupt default handler is rtos_dummyINTCInterruptHandler(). It does nothing in PRODUCTION compilation but an assertion will fire in DEBUG compilation in order to indicate the missing true handler for an enabled interrupt. The dummy interrupt handlers are registered for handling by core 0.<br />
 Note, this function temporarily clears the enable External Interrupts bit in the machine status register but won't have changed it on return. Usually, you will call it at system startup time, when all interrupts are still disabled, then call <a class="el" href="rtos__external_interrupt_8c.html#a10a6460ff9e902f2d0ac42394e0e4fea">rtos_osRegisterInterruptHandler()</a> repeatedly for all interrupts your code is interested in, then start the other cores and eventually enable the interrupt processing at the CPUs. </p><dl class="section remark"><dt>Remarks</dt><dd>This function must be called from supervisor mode only. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000009">Todo:</a></b></dt><dd>This can become a sub-routine, which can then be applied in registerService to check user input </dd></dl>

</div>
</div>
<a class="anchor" id="a10a6460ff9e902f2d0ac42394e0e4fea"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rtos_osRegisterInterruptHandler </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="rtos_8h.html#a671a05cb46411e64b58a457394c3e749">rtos_interruptServiceRoutine_t</a>&#160;</td>
          <td class="paramname"><em>pInterruptHandler</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>processorID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>vectorNum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>psrPriority</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>isPreemptable</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This function can be used to install an interrupt service for a given I/O device and a given core. It will also set the Priority Select Register for the I/O device's IRQ to the desired value. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pInterruptHandler</td><td>The interrupt service routine by reference. An ordinary C function in the user code area, which is called when the according interrupt is served. </td></tr>
    <tr><td class="paramname">processorID</td><td>The interrupt is assigned to the processor of this ID. Allowed are: 0 for Z4A, 1 for Z4B or 2 for Z2.<br />
 Note, the implementation avoids having different vector tables for the three cores. The work assumption is that an I/O interrupt will normally be served by either one or another core. The INTC HW permits signalling any interrupt to any set of cores. Both statements are combined in that setting an interrupt vector to a core A will cause an assertion if the same interrupt had been registered already before for another core B and the registration for A had specified another interrupt service routine.<br />
 In the rare case of needing one interrupt on different cores the ISR needs to query the processor ID so that the implementation of the handler can become processor dependent. </td></tr>
    <tr><td class="paramname">vectorNum</td><td>All possible external interrupt sources are hardwired to the interrupt controller. They are indentified by index. The table, which interrupt source (mostly I/O device) is connected to the controller at which index can be found in the MCU reference manual, section 23.1.2, table 23-1, p. 523ff. </td></tr>
    <tr><td class="paramname">psrPriority</td><td>The priority at which the interrupt is served. Range is 0..15, checked by assertion. 0 is useless, it would never be served, 1 is the lowest real priority and 15 the highest. Preemption of a handler (if enabled), which serves an interrupt of priority n will be possible only by another interrupt of priority n+1 or higher. </td></tr>
    <tr><td class="paramname">isPreemptable</td><td>For each interrupt it can be said, whether it is preemptable by other interrupts of higher priority or not. If this is <em>false</em> then the interrupt handler will always be entered with the status bit EE reset in the machine status register MSR of the servicing core.<br />
 Note, a handler, which has been declared non-premptable is allowed to set the EE bit itself. It can thus first do some operations without any race-conditions with other interrupts and then continue without further locking normal interrupt processing. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section remark"><dt>Remarks</dt><dd>The function can be used at any time. It is possible to exchange a handler at run-time, while interrrupts are being processed, but only on the processor, which invokes this function. However, the normal use case will rather be to call this function for all required interrupts and only then call the other function inc_resumeAllInterrupts() on all the processors.<br />
 This function must not be called for an interrupt vector number n from within an ISR of that interrupt vector number and it must not be called from processor i for processor j!=i, if that processor is running. </dd>
<dd>
On an MPC5748G, all cores share the function code. A core should use this function to install its ISRs, regardless whether or not it runs the RTOS. A typical scenario would be running the RTOS only on one core, but the others should still use this function to install their ISRs. </dd>
<dd>
This function must be called from supervisor mode only. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000010">Todo:</a></b></dt><dd>Check: Why do we have a macro IRQ_Handler with argument isPreemtable but we still need an if? </dd></dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="af34c0be87ce8f08cd2ae73d5469ac308"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="rtos_8h.html#a671a05cb46411e64b58a457394c3e749">rtos_interruptServiceRoutine_t</a> rtos_endOfINTCInterruptHandlerAry[0]</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The assembly code in rtos_ivorHandler.S, which defines the table of External Interrupt handlers exports the end of the table area in order to support some consistency tests. The declaration is not needed besides an assertion and is therefore not made public. We require an external declaration to become able to access it. </p>

</div>
</div>
<a class="anchor" id="aca10086c1117b052b672a8ff90147edc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint32_t inc_pirUnregisteredInterrupt = UINT32_MAX</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>If a an unregistered interrupt service has been reported by <em>inc_idxUnregisteredInterrupt</em> then this variable holds the ID of the processor core, which had taken the interrupt. </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd><p class="startdd">This variable should reside in shared, uncached memory. </p>
<p class="enddd">Bad naming: inc_ vs. rtos_ </p>
</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Looks like a bug not to put this in OS memory? </dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_050edd66366d13764f98250ef6db77f6.html">code</a></li><li class="navelem"><a class="el" href="dir_9cd24f4fec2e6f6bedbcc5407321d78a.html">system</a></li><li class="navelem"><a class="el" href="dir_34effe5aae1be93d744f092611be46f1.html">RTOS</a></li><li class="navelem"><a class="el" href="rtos__external_interrupt_8c.html">rtos_externalInterrupt.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
